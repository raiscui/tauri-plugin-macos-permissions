# PhotoKit 系统相册权限功能需求

## 执行摘要
为 tauri-plugin-macos-permissions 插件添加 PhotoKit 系统相册权限的检查和请求功能，使 Tauri 应用能够访问用户的照片库。该功能将与现有的权限管理系统保持一致，提供统一的 API 接口。

## 利益相关者
- **Tauri 应用开发者**: 需要在应用中访问用户照片库的开发者
- **最终用户**: 使用 Tauri 应用的 macOS 用户，需要控制照片库访问权限
- **系统管理员**: 需要管理企业环境中应用权限的管理员
- **插件维护者**: 负责维护和扩展插件功能的开发者

## 功能性需求

### FR-001: 检查 PhotoKit 权限状态
**描述**: 提供检查当前应用是否具有 PhotoKit 照片库访问权限的功能
**优先级**: 高
**验收标准**:
- [ ] 能够检查应用的 PhotoKit 权限状态
- [ ] 返回明确的布尔值表示权限状态
- [ ] 在非 macOS 平台返回 true（兼容性）
- [ ] 支持异步调用
- [ ] 提供清晰的 API 文档和示例

### FR-002: 请求 PhotoKit 权限
**描述**: 提供请求 PhotoKit 照片库访问权限的功能
**优先级**: 高
**验收标准**:
- [ ] 能够触发系统权限请求对话框
- [ ] 处理用户授权或拒绝的情况
- [ ] 在非 macOS 平台安全返回（兼容性）
- [ ] 支持异步调用
- [ ] 提供适当的错误处理

### FR-003: 权限级别支持
**描述**: 支持 PhotoKit 的所有权限级别（只读、读写、添加）
**优先级**: 高
**验收标准**:
- [ ] 支持只读权限 (PHAccessLevelRead)
- [ ] 支持读写权限 (PHAccessLevelReadWrite)
- [ ] 支持添加权限 (PHAccessLevelAddOnly)
- [ ] 允许开发者指定所需的权限级别
- [ ] 提供权限级别枚举和转换

### FR-004: 权限状态枚举
**描述**: 提供详细的权限状态信息，不仅仅是简单的布尔值
**优先级**: 中
**验收标准**:
- [ ] 支持未确定、已授权、已拒绝、受限等状态
- [ ] 与 iOS/macOS PhotoKit 权限状态保持一致
- [ ] 提供状态码到可读字符串的转换
- [ ] 支持 JSON 序列化

### FR-005: 权限状态实时监听
**描述**: 监听权限状态变化，当用户在系统设置中修改权限时及时通知
**优先级**: 高
**验收标准**:
- [ ] 注册权限状态变化监听器
- [ ] 当权限状态改变时触发回调
- [ ] 提供取消监听的机制
- [ ] 支持多个监听器同时存在

### FR-006: 与现有权限系统集成
**描述**: 新功能应与插件现有的权限管理模式保持一致
**优先级**: 高
**验收标准**:
- [ ] 遵循现有的命名约定（check_*_permission, request_*_permission）
- [ ] 使用相同的错误处理模式
- [ ] 保持 API 设计的一致性
- [ ] 支持相同的平台兼容性策略

## 非功能性需求

### NFR-001: 性能
**描述**: 权限检查和请求操作的性能要求
**指标**:
- 权限检查响应时间 < 100ms
- 权限请求触发时间 < 200ms
- 内存占用增加 < 1MB

### NFR-002: 安全性
**描述**: 确保权限操作的安全性和隐私保护
**标准**:
- 遵循 Apple 的隐私和安全指南
- 不存储或传输用户照片数据
- 仅检查权限状态，不访问实际照片内容
- 支持 macOS 沙盒环境

### NFR-003: 兼容性
**描述**: 平台和版本兼容性要求
**指标**:
- 支持 macOS 10.15+ (PhotoKit 可用的最低版本)
- 与 Tauri 2.x 兼容
- 在非 macOS 平台优雅降级
- 向后兼容现有插件 API

### NFR-004: 可维护性
**描述**: 代码质量和维护性要求
**标准**:
- 遵循 Rust 最佳实践
- 提供完整的单元测试
- 包含详细的文档和示例
- 使用类型安全的 API 设计

## 约束条件
- **技术约束**: 必须使用 Rust 和 Objective-C 互操作
- **平台约束**: PhotoKit 仅在 macOS 10.15+ 可用
- **框架约束**: 必须与 Tauri 2.x 插件架构兼容
- **依赖约束**: 尽量减少新的外部依赖

## 假设条件
- 用户运行的是支持 PhotoKit 的 macOS 版本
- 应用已正确配置 Info.plist 中的权限描述
- 开发者了解 macOS 权限系统的基本概念
- 应用在沙盒环境中正常运行

## 范围外
- 实际的照片访问和操作功能
- 照片元数据的读取和修改
- 照片库的同步和备份功能
- 其他媒体类型（视频、音频）的权限管理
- 第三方照片应用的集成

## Info.plist 配置要求
应用必须在 Info.plist 中配置以下权限描述：

```xml
<!-- 基本照片库访问权限 -->
<key>NSPhotoLibraryUsageDescription</key>
<string>此应用需要访问照片库以便...</string>

<!-- 添加照片到照片库的权限 -->
<key>NSPhotoLibraryAddUsageDescription</key>
<string>此应用需要向照片库添加照片以便...</string>
```

## 技术实现考虑
- 使用 PhotoKit 框架的 PHPhotoLibrary.authorizationStatus() 和 PHPhotoLibrary.requestAuthorization() 方法
- 支持不同的权限级别 (PHAccessLevel)
- 通过 objc2 crate 进行 Objective-C 互操作
- 遵循现有代码的错误处理模式
- 实现权限状态变化的实时监听机制
- 要求 macOS 10.15+ (不支持向后兼容)
