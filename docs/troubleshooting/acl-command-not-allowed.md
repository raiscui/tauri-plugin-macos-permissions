# Tauri ACL 权限错误解决方案

## 问题描述

在 Tauri 应用运行时遇到以下错误：

```
[ERROR] 查询照片数量失败: Command plugin:macos-permissions-with-photokit|get_photos_count not allowed by ACL
```

## 错误原因

这个错误表明 Tauri 的访问控制列表（ACL）不允许执行指定的命令。在 Tauri 2.0 中，所有插件命令都必须在权限配置中明确声明才能被调用。

**根本原因**：
- 插件中定义了 `get_photos_count` 命令
- 但该命令没有被包含在构建系统的权限生成配置中
- 导致没有生成对应的权限配置文件
- 应用运行时 ACL 检查失败

## 解决步骤

### 1. 检查命令是否在构建配置中

查看项目根目录的 `build.rs` 文件，确认命令是否在 `COMMANDS` 数组中：

```rust
// build.rs
const COMMANDS: &[&str] = &[
    "check_accessibility_permission",
    "request_accessibility_permission",
    // ... 其他命令
    "get_photos_count", // ← 确保这个命令在列表中
];
```

### 2. 添加缺失的命令

如果命令不在列表中，需要添加：

```rust
const COMMANDS: &[&str] = &[
    "check_accessibility_permission",
    "request_accessibility_permission",
    "check_full_disk_access_permission",
    "request_full_disk_access_permission",
    "check_screen_recording_permission",
    "request_screen_recording_permission",
    "check_microphone_permission",
    "request_microphone_permission",
    "check_camera_permission",
    "request_camera_permission",
    "check_input_monitoring_permission",
    "request_input_monitoring_permission",
    "check_photokit_permission",
    "request_photokit_permission",
    "register_photokit_permission_listener",
    "unregister_photokit_permission_listener",
    "get_photokit_permission_listeners",
    "get_photos_count", // ← 新添加的命令
];
```

### 3. 更新默认权限配置

编辑 `permissions/default.toml` 文件，添加新命令的权限：

```toml
"$schema" = "schemas/schema.json"

[default]
description = "Default permissions for the plugin"
permissions = [
    "allow-check-accessibility-permission",
    "allow-request-accessibility-permission",
    # ... 其他权限
    "allow-get-photos-count", # ← 添加新权限
]
```

### 4. 重新构建项目

```bash
# 在项目根目录执行
cargo build
```

这会自动生成权限配置文件：`permissions/autogenerated/commands/get_photos_count.toml`

### 5. 重新构建 Tauri 应用

```bash
# 在示例应用目录执行
cd examples/tauri-app
pnpm tauri build
```

### 6. 测试修复结果

**重要**：必须使用构建后的应用进行测试，而不是开发模式：

```bash
# ❌ 错误：开发模式无法正确测试权限
pnpm tauri dev

# ✅ 正确：使用构建后的应用
open src-tauri/target/release/bundle/macos/tauri-app.app
```

## 验证修复

### 检查权限文件生成

确认以下文件已生成：

```
permissions/autogenerated/commands/get_photos_count.toml
```

文件内容应该类似：

```toml
# Automatically generated - DO NOT EDIT!

"$schema" = "../../schemas/schema.json"

[[permission]]
identifier = "allow-get-photos-count"
description = "Enables the get_photos_count command without any pre-configured scope."
commands.allow = ["get_photos_count"]

[[permission]]
identifier = "deny-get-photos-count"
description = "Denies the get_photos_count command without any pre-configured scope."
commands.deny = ["get_photos_count"]
```

### 检查应用日志

运行构建后的应用，查看日志文件：

```bash
# 查看日志
tail -f ~/Library/Logs/com.tauri-app.app/tauri-app.log
```

成功的日志应该显示：

```
[INFO] 开始查询照片数量
[INFO] 照片数量查询成功: XXXX 张照片
```

而不是之前的错误：

```
[ERROR] Command plugin:macos-permissions-with-photokit|get_photos_count not allowed by ACL
```

## 关键要点

1. **权限配置是必需的**：Tauri 2.0 要求所有命令都必须有明确的权限配置
2. **构建系统自动化**：通过 `build.rs` 中的 `COMMANDS` 数组自动生成权限文件
3. **默认权限集合**：`permissions/default.toml` 定义了插件的默认权限
4. **测试环境重要性**：权限功能必须在构建后的应用中测试，开发模式无法正确处理系统权限

## 预防措施

为避免类似问题，在添加新命令时应该：

1. 在 `src/commands.rs` 中定义命令函数
2. 在 `build.rs` 的 `COMMANDS` 数组中添加命令名
3. 在 `permissions/default.toml` 中添加对应权限
4. 重新构建项目生成权限文件
5. 使用构建后的应用进行测试

## 相关文档

- [Tauri 权限系统文档](https://tauri.app/v1/guides/features/command#permissions)
- [Tauri 插件开发指南](https://tauri.app/v1/guides/building/plugins)
